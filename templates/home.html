{% extends "base.html" %}
{% block content %}

<style>
    body {
        background: linear-gradient(to right, #f8fbff, #e0f7fa);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
        max-width: 900px;
        margin: auto;
    }
    .card {
        border-radius: 15px;
        border: none;
        background: white;
        transition: all 0.3s ease;
    }
    .card:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    .btn-pink {
        background-color: #ff4081;
        color: white;
        border: none;
    }
    .btn-pink:hover {
        background-color: #e91e63;
    }
    h2, h4 {
        color: #2c3e50;
    }
    .alert {
        border-radius: 10px;
        font-size: 0.95rem;
    }
</style>
<div class="container mt-5">
    <h2>Welcome, {{ patient.name if patient else 'Guest' }}!</h2>

    {% if last_prediction %}
    <div class="card mt-4 p-4 shadow-sm">
        <h4>ü©∫ Your Latest Prediction</h4>
        <p><strong>Result:</strong> {{ last_prediction.prediction }}</p>
        <p><strong>Confidence:</strong> {{ last_prediction.confidence }}%</p>
        <p><strong>Date:</strong> {{ last_prediction.timestamp }}</p>

        {% if health_status == 'High' %}
            <div class="alert alert-danger mt-3">
                üö® High Risk Detected. Consider consulting a specialist.
            </div>
        {% else %}
            <div class="alert alert-success mt-3">
                ‚úÖ Risk appears low. Maintain regular checkups.
            </div>
        {% endif %}

        {% if 'FamilyHistory' in last_prediction and last_prediction['FamilyHistory'] == 'Yes' %}
            <div class="alert alert-warning mt-2">
                üìå Note: Review your family medical history with a professional.
            </div>
        {% endif %}
    </div>
    {% else %}
    <div class="alert alert-info mt-4">
        No predictions found yet. Head to the Prediction page to get started!
    </div>
    {% endif %}

    <!-- üë§ Patient Info Section -->
    <div class="card mt-5 p-4 shadow-sm">
        <h4>üë§ Your Patient Information</h4>

        {% if patient %}
            <p><strong>Name:</strong> {{ patient.name }}</p>
            <p><strong>Parent's Name:</strong> {{ patient.parent_name }}</p>
            <p><strong>Date of Birth:</strong> {{ patient.dob }}</p>
            <p><strong>Weight:</strong> {{ patient.weight }} kg</p>
            <p><strong>Height:</strong> {{ patient.height }} cm</p>
            <p><strong>Previous Health Issues:</strong> {{ patient.previous_health_issues or 'None' }}</p>
            <p><strong>Parent's Health History (Breast Cancer):</strong> {{ patient.parent_health_issues or 'None' }}</p>
            <a href="{{ url_for('edit_info') }}" class="btn btn-pink">Edit Information</a>
        {% else %}
            <form method="POST" action="{{ url_for('submit_info') }}">
                <div class="mb-3">
                    <label>Name</label>
                    <input type="text" name="name" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Parent's Name</label>
                    <input type="text" name="parent_name" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Date of Birth</label>
                    <input type="date" name="dob" class="form-control" required max="{{ max_date }}">
                </div>
                <div class="mb-3">
                    <label>Weight (kg)</label>
                    <input type="number" name="weight" class="form-control" step="0.1" required>
                </div>
                <div class="mb-3">
                    <label>Height (cm)</label>
                    <input type="number" name="height" class="form-control" step="0.1" required>
                </div>
                <div class="mb-3">
                    <label>Previous Health Issues</label>
                    <textarea name="previous_health_issues" class="form-control"></textarea>
                </div>
                <div class="mb-3">
                    <label>Parent's Health History (related to breast cancer)</label>
                    <textarea name="parent_health_issues" class="form-control"></textarea>
                </div>
                <button type="submit" class="btn btn-pink">Save Info</button>
            </form>
        {% endif %}
    </div>

    <!-- üè• Nearby Hospitals Section -->
    <div class="card mt-5 p-4 shadow-sm">
        <h4>üè• Nearby Medical Support</h4>
        <ul id="hospital-list" class="list-group">
            <li class="list-group-item">Loading nearby hospitals...</li>
        </ul>
    </div>
</div>

<script>
// Get nearby hospitals based on user location
document.addEventListener("DOMContentLoaded", () => {
    const hospitalList = document.getElementById("hospital-list");

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const { latitude, longitude } = position.coords;
                fetch(`/nearby-hospitals?lat=${latitude}&lon=${longitude}`)
                    .then(res => res.json())
                    .then(data => {
                        hospitalList.innerHTML = "";
                        data.forEach(h => {
                            const li = document.createElement("li");
                            li.className = "list-group-item";
                            li.innerHTML = `<strong>${h.name}</strong><br><small>${h.address}</small>`;
                            hospitalList.appendChild(li);
                        });

                        // Scroll to bottom after loading
                        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                    });
            },
            error => {
                hospitalList.innerHTML = `<li class='list-group-item text-danger'>‚ö†Ô∏è Location access denied. Enable it to fetch nearby hospitals.</li>`;
            }
        );
    } else {
        hospitalList.innerHTML = `<li class='list-group-item text-danger'>‚ö†Ô∏è Geolocation is not supported on this browser.</li>`;
    }
});
</script>
{% endblock %}
